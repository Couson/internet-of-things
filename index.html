<!DOCTYPE html>
<html>

<head>
  <title>DSC190 Map Viewer</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <meta name="viewport" content="initial-scale=1.0">
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
  <script src="https://code.highcharts.com/stock/highstock.js"></script>
  <script src="https://code.highcharts.com/stock/modules/data.js"></script>
  <script src="https://code.highcharts.com/stock/highcharts-more.js"></script>
  <script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/stock/modules/export-data.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.13/moment-timezone-with-data-2012-2022.min.js"></script>
  <style>
    /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
    #map {
      height: 100%;
    }

    /* Optional: Makes the sample page fill the window. */
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
</head>

<body>
  <div id='navbar'>
    <button id="btn-display" onclick="toggleMyMarker()"
      style="position:fixed; margin-left: 45%; margin-right: 45%; z-index: 10;">Hide Other Markers</button>
  </div>
  <div id="mySidebar" style="display: none;">
    <button id='btn-hide' onclick="hideSidebar()"
      style="position:fixed;margin-left: 80%; margin-right: 10%; z-index: 10;">Close Sidebar</button>
    <div id='w3-sidebar' class="w3-sidebar w3-bar-block w3-collapse w3-card w3-animate-right"
      style="width:45%; right:0;">

      <div id="series_chart_div" style="width: 100%;"></div>

    </div>

  </div>
  <div id="map"></div>

  <script>

    // init charts
    google.charts.load('current', { 'packages': ['gauge'] });
    //      google.charts.setOnLoadCallback(drawGauges);
    var otherMarkers = [];

    function toggleMyMarker() {
      var toggleButton = document.getElementById("btn-display");
      // console.log(toggleButton.innerHTML);
      if (toggleButton.innerHTML == "Hide Other Markers") {

        otherMarkers.forEach(blockMarker);
        toggleButton.textContent = "Show Other Markers";
      }

      else if (toggleButton.innerHTML == "Show Other Markers") {

        otherMarkers.forEach(showMarker);
        toggleButton.textContent = "Hide Other Markers";
      }
    };

    function blockMarker(marker) {
      marker.setVisible(false);
    };

    function showMarker(marker) {
      marker.setVisible(true);
    };

    function initMap() {



      var ourClass = "null";

      //  var exLink = '<iframe width=1000 height=600 src="http://cse191iot.ucsd.edu/ian/sample_viewer.html"></iframe>';
      var exLink = '<iframe width=400 height=400 src="http://dsc-iot.ucsd.edu/gid03/view.html"></iframe>';

      // var exinfowindow = new google.maps.InfoWindow({
      //   content: exLink,
      //   maxWidth: 1000,
      //   maxHeight: 600
      // });


      var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 15,
        center: { lat: 32.883, lng: -117.234 },
        title: 'UCSD CSE191'
      });


      placeMarker();
      getGlobalData(); //return globalData
      // place marker by devices

      function placeMarker() {
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onload = function () {
          if (this.readyState == 4 && this.status == 200) {
            // console.log(this.responseText);
            var statsObj = JSON.parse(this.responseText);
            statsObj.devices.forEach(fillingInfo);
          }
        };

        var cmdObj = { "cmd": "LIST" };
        var cmdStr = JSON.stringify(cmdObj);
        xmlhttp.open("POST", "http://dsc-iot.ucsd.edu/gid03/cgi-bin/API.py", true);
        xmlhttp.setRequestHeader('Content-Type', 'application/json');
        xmlhttp.send(cmdStr);
      };

      function fillingInfo(device) {
        var gid = device.groupID;
        var devmac = device.mac;
        var status = device.status;
        var lon = device.dev_long;
        var lat = device.dev_lat;
        var ts = device.lastseen;


        if (lon == null || lat == null) {
          return 'invalid device position'
        };


        /* null lat & lon val */
        var iconColor;
        if (status == 'OK') {
          iconColor = 'green';
        }

        else if (status == 'ERROR') {
          iconColor = 'red';
        }

        else if (status == 'TIMEOUT') {
          iconColor = 'red';
        }
        else if (status == 'WARNING') {
          iconColor = 'yellow';
        }

        else {
          iconColor = 'blue';
        }


        let marker = new google.maps.Marker({
          map: map,
          position: { lat: lat, lng: lon },
          icon: {
            url: `http://maps.google.com/mapfiles/ms/icons/${iconColor}-dot.png`
          },
          title: `marker-${devmac}, groupID-${gid}, status-${status}, lastseen-${ts}`,
          visible: true
        });

        if (gid != '3') {
          otherMarkers.push(marker);
          // console.log(devmac);
        };

        var infowindow = new google.maps.InfoWindow({
          width: 8000,
          height: 8000
        });


        var exinfowindow = new google.maps.InfoWindow({
          content: exLink,
          maxWidth: 1000,
          maxHeight: 600
        });

        marker.addListener('click', function () {
          showSidebar();
          // infowindow.open(map, marker);
          /* initalize the infowindow and then do updates.. */
          // updateBleInfo(infowindow, devmac);

        });

        // marker.addListener('ondblclick', showSidebar);

        marker.addListener('mouseover', function () {
          infowindow.open(map, marker);
          // exinfowindow.open(map, marker);
          drawTempHumChart(infowindow, devmac);
        });

        marker.addListener('mouseout', function () {
          // infowindow.close();
        });
      }

      // function updateDevInfo(window, devmac) {

      //   // do some AJAX magic to show updated data
      //   var xmlhttp = new XMLHttpRequest();

      //   xmlhttp.onreadystatechange = function () {

      //     if (this.readyState == 4 && this.status == 200) {
      //       var statsObj = JSON.parse(this.responseText);
      //       var ourClass = "";

      //       var devmac = statsObj.devices[0].mac;
      //       var gid = statsObj.devices[0].groupID;
      //       var lastseen = statsObj.devices[0].lastseen;
      //       var status = statsObj.devices[0].status;

      //       ourClass += "<table class= 'table' id = 'devicesTable'>"
      //       ourClass += "<thead>"
      //       ourClass += "<tr>"
      //       ourClass += "<th>timestamp </th>"
      //       ourClass += "<th>devmac </th>"
      //       ourClass += "<th>gid </th>"
      //       ourClass += "<th>status </th>"
      //       ourClass += "</tr>"
      //       ourClass += `<tr><td>${lastseen}</td><td>${devmac}</td><td>${gid}</td><td>${status}</td></tr>`
      //       ourClass += "</thead>"
      //       ourClass += "</table>"
      //       window.setContent(ourClass);
      //     }
      //   };

      //   var cmdObj = { "cmd": "LIST", "mac": devmac };
      //   var cmdStr = JSON.stringify(cmdObj);
      //   xmlhttp.open("POST", "http://dsc-iot.ucsd.edu/gid03/cgi-bin/API.py", true);
      //   xmlhttp.setRequestHeader('Content-Type', 'application/json');
      //   xmlhttp.send(cmdStr);
      // };

      function drawTempHumChart(window, devmac) {

        // do some AJAX magic to show updated data
        var xmlhttp = new XMLHttpRequest();

        xmlhttp.onreadystatechange = function () {

          if (this.readyState == 4 && this.status == 200) {
            var statsObj = JSON.parse(this.responseText);
            var tempList = [['Hour', 'Temp', 'Hum']];
            // var humList = [['Hour', 'Hum']];;
            for (var i = 0; i < statsObj.weather.length; i++) {
              var temp = statsObj.weather[i].avg_temp;
              var hum = statsObj.weather[i].avg_hum;
              var hour = statsObj.weather[i].hour;
              var day = statsObj.weather[i].day;
              var month = statsObj.weather[i].month;

              var timestamp = Date.UTC(2020, parseInt(month), parseInt(day), parseInt(hour));

              var tempRow = [timestamp, temp, hum];
              // var humRow = [hour, hum];
              tempList.push(tempRow);
              // humList.push(humRow);
            };

            // var tempData = google.visualization.arrayToDataTable(tempList);

            // var tempOptions = {
            //   title: 'Leads',
            //   hAxis: { showTextEvery: 5 },
            //   vAxes: {
            //     0: {
            //       viewWindowMode: 'explicit',
            //       viewWindow: {
            //         max: '100%',
            //         min: '50%'
            //       },
            //       gridlines: { color: 'transparent' },
            //     },
            //     1: {
            //       gridlines: { color: 'transparent' },
            //       format: "#%"
            //     },
            //   },
            //   series: {
            //     0: { targetAxisIndex: 0 },
            //     1: { targetAxisIndex: 1 },
            //   },
            //   colors: ["red", "green"],
            // };

            // var node = document.createElement('div');
            // // var humNode = document.createElement('div');

            // var tempChart = new google.visualization.LineChart(node);
            // // var humChart = new google.visualization.LineChart(node);

            // tempChart.draw(tempData, tempOptions);
            // // tempChart.draw(humData, humOptions);git

            // window.setContent(node);
            // window.addContent(humNode);
          }
        };

        var cmdObj = { "cmd": "WEATHER", "devmac": devmac };
        var cmdStr = JSON.stringify(cmdObj);
        xmlhttp.open("POST", "http://dsc-iot.ucsd.edu/gid03/cgi-bin/API.py", true);
        xmlhttp.setRequestHeader('Content-Type', 'application/json');
        xmlhttp.send(cmdStr);
      };
    };



    // viz    
    function getGlobalData() {
      var xmlhttp = new XMLHttpRequest();
      xmlhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {

          var statsObj = JSON.parse(this.responseText);

          globalData = statsObj.weather;
          // console.log(globalData);

          humData = [];
          tempData = [];


          // var humList = [['Hour', 'Hum']];;
          for (var i = 0; i < statsObj.weather.length; i++) {
            var temp = globalData[i].avg_temp;
            var hum = globalData[i].avg_hum;

            var hour = globalData[i].hour;
            var day = globalData[i].day;
            var month = globalData[i].month;

            var timestamp = Date.UTC(2020, parseInt(month), parseInt(day), parseInt(hour));

            var tempRow = [timestamp, parseFloat(temp)];
            var humRow = [timestamp, parseFloat(hum)];
            console.log(tempRow);

            tempData.push(tempRow);
            humData.push(humRow);

          }
        };

        var jObj;
        jObj = { cmd: "WEATHER" };
        var cmdStr = JSON.stringify(jObj);
        xmlhttp.open("POST", "http://dsc-iot.ucsd.edu/gid03/cgi-bin/API.py", true);
        xmlhttp.setRequestHeader('Content-Type', 'application/json');
        xmlhttp.send(cmdStr);
      };

      function drawGauge(rssi) {

        var dataRSSI = google.visualization.arrayToDataTable([
          ['Label', 'Value'],
          ['RSSI dB', 0],
        ]);

        var optionsR = {
          width: 160, height: 120,
          redFrom: -99, redTo: -90,
          yellowFrom: -89, yellowTo: -75,
          greenFrom: -74, greenTo: 0,
          minorTicks: 5,
          max: 0,
          min: -100
        };

        var RSSIchart = new google.visualization.Gauge(document.getElementById('RSSIchart_div'));
        dataRSSI.setValue(0, 1, rssi);
        RSSIchart.draw(dataRSSI, optionsR);

      }

    }

    function drawHighChart(tempData, humData) {
      var chartDiv = document.createElement('div');
      chartDiv.className = 'chart';
      chartDiv.style.width = '100%';

      document.getElementById('w3-sidebar').appendChild(chartDiv);

      Highcharts.stockChart(chartDiv, {

        rangeSelector: {
          selected: 2
        },
        xAxis: {
          type: 'datetime'
        },
        yAxis: [{ // Primary yAxis
          labels: {
            format: '{value}°C',
            style: {
              color: Highcharts.getOptions().colors[0]
            }
          },
          title: {
            text: 'Temperature',
            style: {
              color: Highcharts.getOptions().colors[0]
            }
          },
          opposite: true

        }, { // Secondary yAxis
          gridLineWidth: 0,
          title: {
            text: 'Humidity',
            style: {
              color: Highcharts.getOptions().colors[1]
            }
          },
          labels: {
            format: '{value} %',
            style: {
              color: Highcharts.getOptions().colors[1]
            }
          },
          opposite: false

        }],

        title: {
          text: 'Average Temperature and Humidity variation'
        },

        series: [{
          name: 'Temperatures',
          data: tempData,
          tooltip: {
            valueSuffix: '°C'
          },
        }, {
          name: 'Humidity',
          data: humData,
          tooltip: {
            valueSuffix: '%'
          },
          yAxis: 1,
        }],

      });
    };

    function drawBubbleChart() {

      readTextFile('./assets/viz-data.json', function (text) {
        var jObj = JSON.parse(text);
        var rawData = [];

        // rawData.push(Object.keys(jObj[0]));
        rawData.push(['id', 'lat', 'lon', 'devmac', 'count']);

        for (var i in jObj) {
          var devmac = jObj[i].devmac;
          var count = jObj[i]["COUNT(DISTINCT blemac)"];
          var lat = jObj[i].dev_lat;
          var lon = jObj[i].dev_long;
          rawData.push([null, lat, lon, devmac, count]);

        }
        var options = {
          title: 'population density estimated by rssi counts',
          hAxis: { title: 'latitude' },
          vAxis: { title: 'longitude' },
          bubble: { textStyle: { fontSize: 11 } }
        };
        // console.log(rawData)
        var data = google.visualization.arrayToDataTable(rawData)
        var chart = new google.visualization.BubbleChart(document.getElementById('series_chart_div'));
        chart.draw(data, options);



      })
    }

    function hideSidebar() {
      var sidebar = document.getElementById("mySidebar")
      if (sidebar.style.display == 'block') {
        sidebar.style.display = "none";
      }
    };

    function showSidebar() {
      document.getElementById("mySidebar").style.display = "block";
    }

    function readTextFile(file, callback) {
      var rawFile = new XMLHttpRequest();
      rawFile.overrideMimeType("application/json");
      rawFile.open("GET", file, true);
      rawFile.onreadystatechange = function () {
        if (rawFile.readyState === 4 && rawFile.status == "200") {
          callback(rawFile.responseText);
        }
      }
      rawFile.send(null);
    }

    google.charts.load('current', { 'packages': ['corechart'] });
    google.charts.setOnLoadCallback(drawBubbleChart);
    drawHighChart(tempData, humData);
    
  </script>
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBRQQ4iVEx6ijcbOgwtc7Y95i7tMdlqtvw&callback=initMap"> </script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</body>

</html>